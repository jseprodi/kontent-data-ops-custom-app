name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Check Node.js version
      run: node --version
    
    - name: Verify build
      run: npm run build
    
    - name: Run tests (if available)
      run: npm test || echo "Tests not yet implemented"
      continue-on-error: true
    
    - name: Check for common issues
      run: |
        echo "Checking for common issues..."
        # Check if required files exist
        test -f index.html && echo "✓ index.html exists" || echo "✗ index.html missing"
        test -f app-frontend.js && echo "✓ app-frontend.js exists" || echo "✗ app-frontend.js missing"
        test -f server.js && echo "✓ server.js exists" || echo "✗ server.js missing"
        test -f manifest.json && echo "✓ manifest.json exists" || echo "✗ manifest.json missing"
        test -f package.json && echo "✓ package.json exists" || echo "✗ package.json missing"
        
        # Check if dist directory is created after build
        test -d dist && echo "✓ dist directory created" || echo "✗ dist directory missing"
        
        # Check if server.js is NOT in dist (security)
        test ! -f dist/server.js && echo "✓ server.js correctly excluded from dist" || echo "✗ WARNING: server.js found in dist"
    
    - name: Upload build artifacts
      if: matrix.node-version == '20.x'
      uses: actions/upload-artifact@v3
      with:
        name: dist-${{ matrix.node-version }}
        path: dist/
        retention-days: 1

  security-check:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Use Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run npm audit
      run: npm audit --audit-level=moderate || true
      continue-on-error: true
    
    - name: Check for sensitive data
      run: |
        echo "Checking for potential sensitive data..."
        # Check for hardcoded API keys (basic check)
        if grep -r "api[_-]key.*=.*['\"][a-zA-Z0-9]{20,}" --include="*.js" --include="*.ts" .; then
          echo "⚠️  WARNING: Potential hardcoded API keys found"
          exit 1
        fi
        echo "✓ No obvious hardcoded API keys found"

